services:
  # ============================================================
  # UPTIME MONITORING
  # ============================================================
  uptime-kuma:
    image: louislam/uptime-kuma:${UPTIME_KUMA_VERSION:-1}
    container_name: uptime-kuma
    volumes:
      - ./data/uptime:/app/data
    ports:
      - "3001:3001"
    restart: always
    networks:
      - monitoring_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M

  # ============================================================
  # NGINX GATEWAY (Basic Auth for ingest endpoints)
  # ============================================================
  gateway:
    image: nginx:latest
    container_name: gateway
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./gateway/.htpasswd:/etc/nginx/.htpasswd:ro
    ports:
      - "80:80"
      - "3000:80"
    restart: always
    networks:
      - monitoring_net
    depends_on:
      - loki
      - mimir
      - tempo
      - grafana

  # ============================================================
  # GRAFANA (Visualization)
  # Access: http://YOUR_SERVER_IP:3005
  # ============================================================
  grafana:
    image: grafana/grafana:${GRAFANA_VERSION:-10.4.2}
    container_name: grafana
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./configs/datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
      - ./configs/dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml
      - ./dashboards:/var/lib/grafana/dashboards
    ports:
      - "3005:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_PANELS_DISABLE_SANITIZE_HTML=true
      - GF_SERVER_DOMAIN=${GRAFANA_DOMAIN:-localhost}
      - GF_SERVER_ROOT_URL=https://${GRAFANA_DOMAIN:-localhost}/
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_SERVER_ENABLE_GZIP=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_COOKIE_SAMESITE=strict
      - GF_SERVER_STRICT_TRANSPORT_SECURITY=true
      - GF_USERS_DEFAULT_THEME=dark
      - GF_EXPLORE_ENABLED=false
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_USERS_VIEWERS_CAN_EDIT=false
      - GF_SNAPSHOTS_EXTERNAL_ENABLED=false
      - GF_AUTH_LOGIN_MAXIMUM_INACTIVE_LIFETIME_DURATION=7d
      - GF_AUTH_LOGIN_MAXIMUM_LIFETIME_DURATION=30d
    restart: unless-stopped
    networks:
      - monitoring_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M

  # ============================================================
  # LOKI (Log Storage — 30 day retention)
  # ============================================================
  loki:
    image: grafana/loki:${LOKI_VERSION:-3.0.0}
    container_name: loki
    volumes:
      - ./configs/loki-config.yaml:/etc/loki/local-config.yaml
      - ./data/loki:/loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped
    networks:
      - monitoring_net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G

  # ============================================================
  # MIMIR (Metrics Storage — Multi-tenant)
  # ============================================================
  mimir:
    image: grafana/mimir:${MIMIR_VERSION:-2.12.0}
    container_name: mimir
    volumes:
      - ./configs/mimir-config.yaml:/etc/mimir.yaml
      - ./data/mimir:/data/mimir
    ports:
      - "9009:9009"
    command: -config.file=/etc/mimir.yaml
    restart: unless-stopped
    networks:
      - monitoring_net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9009/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G

  # ============================================================
  # TEMPO (Distributed Tracing — OpenTelemetry)
  # ============================================================
  tempo:
    image: grafana/tempo:${TEMPO_VERSION:-2.4.1}
    container_name: tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./configs/tempo-config.yaml:/etc/tempo.yaml
      - ./data/tempo:/var/tempo
    ports:
      - "3200:3200"   # Tempo HTTP
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    restart: unless-stopped
    networks:
      - monitoring_net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3200/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M

  # ============================================================
  # BLACKBOX EXPORTER (External HTTP/SSL probes)
  # ============================================================
  blackbox:
    image: prom/blackbox-exporter:latest
    container_name: blackbox
    volumes:
      - ./blackbox.yml:/etc/blackbox_exporter/config.yml
    networks:
      - monitoring_net
    restart: unless-stopped

  # ============================================================
  # PROMETHEUS CENTRAL (Scrapes blackbox + pushes to Mimir)
  # ============================================================
  central_prom:
    image: prom/prometheus:latest
    container_name: central_prom
    volumes:
      - ./central-prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - monitoring_net
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    depends_on:
      - blackbox
      - mimir

networks:
  monitoring_net:
    driver: bridge
