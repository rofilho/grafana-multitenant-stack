networks:
  monitoring:
    driver: bridge

volumes:
  mimir_data:
  loki_data:
  tempo_data:
  grafana_data:

services:

  # ---------- Metrics storage ----------
  mimir:
    image: grafana/mimir:2.13.0
    container_name: mimir
    restart: unless-stopped
    command: ["-config.file=/etc/mimir/mimir.yml"]
    volumes:
      - ./mimir/mimir.yml:/etc/mimir/mimir.yml:ro
      - mimir_data:/data/mimir
    networks:
      - monitoring
    expose:
      - "9009"

  # ---------- Log aggregation ----------
  loki:
    image: grafana/loki:3.3.2
    container_name: loki
    restart: unless-stopped
    command: ["-config.file=/etc/loki/loki.yml"]
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/data/loki
    networks:
      - monitoring
    expose:
      - "3100"

  # ---------- Distributed tracing ----------
  tempo:
    image: grafana/tempo:2.7.1
    container_name: tempo
    restart: unless-stopped
    command: ["-config.file=/etc/tempo/tempo.yml"]
    volumes:
      - ./tempo/tempo.yml:/etc/tempo/tempo.yml:ro
      - tempo_data:/data/tempo
    networks:
      - monitoring
    expose:
      - "3200"  # HTTP API
      - "4317"  # OTLP gRPC
      - "4318"  # OTLP HTTP

  # ---------- Visualization ----------
  grafana:
    image: grafana/grafana:11.4.0
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD}
      - GF_SECURITY_SECRET_KEY=${GF_SECRET_KEY}
      - GF_SERVER_ROOT_URL=http://${STACK_HOST}:${STACK_PORT}/
      - GF_SMTP_ENABLED=${GF_SMTP_ENABLED:-false}
      - GF_SMTP_HOST=${GF_SMTP_HOST:-localhost:25}
      - GF_SMTP_USER=${GF_SMTP_USER:-}
      - GF_SMTP_PASSWORD=${GF_SMTP_PASSWORD:-}
      - GF_SMTP_FROM_ADDRESS=${GF_SMTP_FROM_ADDRESS:-grafana@localhost}
    volumes:
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    networks:
      - monitoring
    expose:
      - "3000"

  # ---------- External HTTP/SSL probes ----------
  blackbox:
    image: prom/blackbox-exporter:v0.25.0
    container_name: blackbox
    restart: unless-stopped
    command: ["--config.file=/etc/blackbox/blackbox.yml"]
    volumes:
      - ./blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    networks:
      - monitoring
    expose:
      - "9115"

  # ---------- Central Prometheus (internal + blackbox scraping) ----------
  prometheus:
    image: prom/prometheus:v3.1.0
    container_name: prometheus
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=2h"
      - "--enable-feature=agent"
    volumes:
      - ./central-prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - monitoring
    expose:
      - "9090"

  # ---------- Nginx gateway (basic auth + tenant routing) ----------
  nginx:
    image: nginx:1.27-alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "${STACK_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    networks:
      - monitoring
    depends_on:
      - mimir
      - loki
      - tempo
      - grafana
