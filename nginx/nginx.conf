worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Suppress version in headers
    server_tokens off;

    # --- Upstream backends ---
    upstream mimir   { server mimir:9009; }
    upstream loki    { server loki:3100; }
    upstream tempo   { server tempo:4318; }
    upstream grafana { server grafana:3000; }

    server {
        listen 80;

        # ----------------------------------------------------------------
        # Grafana UI — no authentication (Grafana handles its own auth)
        # ----------------------------------------------------------------
        location / {
            proxy_pass         http://grafana;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
        }

        # ----------------------------------------------------------------
        # Mimir — Prometheus remote_write ingest
        # Clients POST to /api/v1/push with Basic Auth (user = tenant ID)
        # ----------------------------------------------------------------
        location /api/v1/push {
            auth_basic           "Mimir ingest";
            auth_basic_user_file /etc/nginx/.htpasswd;

            proxy_pass           http://mimir;
            proxy_set_header     X-Scope-OrgID $remote_user;
            proxy_set_header     Host          $host;
        }

        # ----------------------------------------------------------------
        # Loki — Promtail log push
        # Clients POST to /loki/api/v1/push with Basic Auth
        # ----------------------------------------------------------------
        location /loki/api/v1/push {
            auth_basic           "Loki ingest";
            auth_basic_user_file /etc/nginx/.htpasswd;

            proxy_pass           http://loki;
            proxy_set_header     X-Scope-OrgID $remote_user;
            proxy_set_header     Host          $host;
        }

        # ----------------------------------------------------------------
        # Tempo — OTLP HTTP trace ingest
        # Clients POST to /v1/traces with Basic Auth
        # ----------------------------------------------------------------
        location /v1/traces {
            auth_basic           "Tempo ingest";
            auth_basic_user_file /etc/nginx/.htpasswd;

            proxy_pass           http://tempo;
            proxy_set_header     X-Scope-OrgID $remote_user;
            proxy_set_header     Host          $host;
        }

        # ----------------------------------------------------------------
        # Healthcheck — no auth
        # ----------------------------------------------------------------
        location /healthz {
            access_log off;
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }
    }
}
